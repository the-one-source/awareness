<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spectrum of Awareness</title>
<style>
  :root{
    --panel-width:1000px;
    --accent:#666440;
    --bg:#f5f7fa;
    --card:#ffffff;
    --muted:#666;
    --text:#111;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;}
  .panel{width:min(98%,var(--panel-width));max-width:var(--panel-width);background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(20,20,30,0.06);padding:28px;box-sizing:border-box;}
  h1{margin:0 0 14px 0;font-weight:400;color:#444;font-size:22px;text-align:center;}
  .row{display:flex;justify-content:center;gap:12px;align-items:center;margin-bottom:14px;}
  select{padding:8px 12px;font-size:15px;border-radius:8px;border:1px solid #e6e6e6;background:white;}
  p.lead{margin:0 0 12px 0;color:#666;font-size:15px;line-height:1.45;text-align:center;}
  .fixed-slider-wrap{width:100%;display:flex;flex-direction:column;align-items:center;gap:8px;margin:12px 0;}
  .fixed-track{width:92%;max-width:880px;}
  input[type="range"]{-webkit-appearance:none;width:100%;height:12px;border-radius:10px;background:#e6e6e6;outline:none;margin:0;padding:0;}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:34px;height:18px;border-radius:9px;background:var(--accent);box-shadow:0 6px 18px rgba(102,100,64,0.24);border:2px solid white;margin-top:-3px;cursor:pointer;}
  .slider-labels{width:92%;max-width:880px;display:flex;justify-content:space-between;color:var(--muted);font-size:13px;margin-top:6px;user-select:none;}
  .btn{display:inline-block;padding:12px 22px;border-radius:28px;background:var(--accent);color:white;border:none;font-size:15px;cursor:pointer;box-shadow:0 6px 18px rgba(102,100,64,0.18);margin-top:12px;}
  .btn:active{transform:translateY(1px);}
  .result-grid{margin-top:12px;color:#333;font-size:15px;display:flex;gap:12px;justify-content:space-between;align-items:stretch;}
  .result-stage{font-weight:700;flex:1;padding:12px;background:#fbfbfb;border-radius:10px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;min-height:92px;box-sizing:border-box;}
  .result-stage:hover{box-shadow:0 6px 18px rgba(102,100,64,0.06);}
  .result-stage .label{font-size:14px;color:#555;}
  .result-score{font-size:20px;color:#222;margin-top:6px;font-weight:700;}
  .result-dominant{margin-top:16px;padding:14px;background:#fff9e6;border-radius:10px;border:1px solid rgba(102,100,64,0.08);font-size:15px;}
  .stage-details{overflow:hidden;max-height:0;transition:max-height .36s ease;padding:0 10px;box-sizing:border-box;}
  .stage-details.open{max-height:680px;padding:12px 12px 18px 12px;}
  .stage-details .content{font-size:14px;color:#333;line-height:1.45;}
  .stage-details .closeBtn{display:inline-block;margin-top:12px;padding:8px 14px;border-radius:10px;background:#eee;border:none;color:#444;cursor:pointer;}
  footer.note{margin-top:14px;color:#666;font-size:13px;text-align:center;}
  @media (max-width:820px){ .result-grid{flex-direction:column;} .result-stage{width:100%} .panel{padding:18px;} }
  /* RTL handling */
  :root[dir="rtl"] .panel{direction:rtl;}
  :root[dir="rtl"] .slider-labels{direction:rtl;}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" id="panel">

    <h1 id="pageTitle">Spectrum of Awareness</h1>

    <div class="row" id="langRow">
      <select id="langSelect" aria-label="Language">
        <option value="en">English</option>
        <option value="de">Deutsch</option>
        <option value="fa">فارسی</option>
      </select>
    </div>

    <!-- Landing -->
    <div id="landingPane">
      <p class="lead" id="landingText">This is a reflection of my inner consciousness called Spectrum of Awareness. I am answering a series of statements using the slider to indicate my agreement.</p>

      <div class="fixed-slider-wrap">
        <div class="fixed-track">
          <input id="landingSlider" type="range" min="0" max="10" value="5" />
        </div>
        <div class="slider-labels" id="landingLabels">
          <span id="lblLeft">Disagree</span>
          <span id="lblMid">Uncertain</span>
          <span id="lblRight">Agree</span>
        </div>
      </div>

      <div style="text-align:center;"><button id="startBtn" class="btn">Start</button></div>
    </div>

    <!-- Questionnaire (unchanged logic) -->
    <div id="questionPane" class="hidden" aria-live="polite">
      <div id="questionText" role="heading" aria-level="2" style="text-align:center;font-size:18px;line-height:1.45;margin:6px 0 14px 0;"></div>

      <div class="fixed-slider-wrap">
        <div class="fixed-track">
          <input id="questionSlider" type="range" min="0" max="10" value="5" />
        </div>
        <div class="slider-labels" id="questionLabels">
          <span id="qLblLeft">Disagree</span>
          <span id="qLblMid">Uncertain</span>
          <span id="qLblRight">Agree</span>
        </div>
      </div>

      <div style="text-align:center;"><button id="nextBtn" class="btn">Next</button></div>
    </div>

    <!-- Result pane: updated with expandable stage details and integrated logic -->
    <div id="resultPane" class="hidden">
      <div class="result-grid" aria-hidden="false">
        <div class="result-stage" id="stageIButton"><div class="label">Stage I</div><div class="result-score" id="scoreI">0.0</div></div>
        <div class="result-stage" id="stageIIButton"><div class="label">Stage II</div><div class="result-score" id="scoreII">0.0</div></div>
        <div class="result-stage" id="stageIIIButton"><div class="label">Stage III</div><div class="result-score" id="scoreIII">0.0</div></div>
      </div>

      <div id="dominantBox" class="result-dominant"></div>

      <!-- Expandable details for each stage -->
      <div style="margin-top:14px;">
        <div id="stageIDetails" class="stage-details" aria-hidden="true">
          <div class="content" id="stageIContent"></div>
          <button class="closeBtn" data-close="stageIDetails">Close</button>
        </div>

        <div id="stageIIDetails" class="stage-details" aria-hidden="true">
          <div class="content" id="stageIIContent"></div>
          <button class="closeBtn" data-close="stageIIDetails">Close</button>
        </div>

        <div id="stageIIIDetails" class="stage-details" aria-hidden="true">
          <div class="content" id="stageIIIContent"></div>
          <button class="closeBtn" data-close="stageIIIDetails">Close</button>
        </div>
      </div>

      <div style="margin-top:18px;text-align:center;"><button id="restartBtn" class="btn">Restart</button></div>
    </div>

    <footer class="note" id="footerNote" aria-hidden="true"></footer>
  </div>
</div>

<script>
/* ====================================================================
   QUESTIONS (unchanged) - same array as your original (trimmed here for brevity)
   NOTE: In practice keep the existing QUESTIONS array you already have.
   ==================================================================== */
const QUESTIONS = [
  {stage:1,en:"Life happens to me.",de:"Das Leben passiert mir.",fa:"زندگی برای من اتفاق می‌افتد."},
  {stage:2,en:"Life happens through me.",de:"Das Leben passiert durch mich.",fa:"زندگی از طریق من اتفاق می‌افتد."},
  {stage:3,en:"Life happens as me.",de:"Das Leben passiert als ich.",fa:"زندگی همان من است که رخ می‌دهد."},

  {stage:1,en:"I feel life is unfair or against me.",de:"Ich fühle, das Leben ist unfair oder gegen mich.",fa:"من احساس می‌کنم زندگی ناعادلانه است یا علیه من است."},
  {stage:2,en:"I notice patterns repeating and wonder why.",de:"Ich bemerke sich wiederholende Muster und frage mich warum.",fa:"من الگوهای تکراری را مشاهده می‌کنم و می‌پرسم چرا."},
  {stage:3,en:"I see all as one flow of consciousness.",de:"Ich sehe alles als einen Fluss des Bewusstseins.",fa:"من همه چیز را به‌عنوان یک جریان واحد آگاهی می‌بینم."},

  {stage:1,en:"I am the victim of life.",de:"Ich bin das Opfer des Lebens.",fa:"من قربانی زندگی هستم."},
  {stage:2,en:"I am connected to a source (higher self, God).",de:"Ich bin mit einer Quelle (höheres Selbst, Gott) verbunden.",fa:"من به یک منبع (خود برتر، خدا) متصل هستم."},
  {stage:3,en:"I am the only source; God is a concept within me.",de:"Ich bin die einzige Quelle; Gott ist ein Konzept in mir.",fa:"من تنها منبع هستم؛ خدا مفهومی درون من است."},

  {stage:1,en:"I need validation to feel seen.",de:"Ich brauche Bestätigung, um gesehen zu werden.",fa:"من برای دیده شدن به تأیید نیاز دارم."},
  {stage:2,en:"I am validated and seen.",de:"Ich bin bestätigt und gesehen.",fa:"من تأیید و دیده شده‌ام."},
  {stage:3,en:"I am the only validation.",de:"Ich bin die einzige Bestätigung.",fa:"من تنها تأیید هستم."},

  {stage:1,en:"I blame society for everything I experience.",de:"Ich gebe der Gesellschaft die Schuld für alles, was ich erlebe.",fa:"من جامعه را برای همه چیز سرزنش می‌کنم."},
  {stage:2,en:"I blame myself for what I experience.",de:"Ich gebe mir selbst die Schuld für das, was ich erlebe.",fa:"من خودم را برای تجربه‌هایم سرزنش می‌کنم."},
  {stage:3,en:"I blame no one; all arises from me.",de:"Ich gebe niemandem die Schuld; alles entsteht aus mir.",fa:"من کسی را سرزنش نمی‌کنم؛ همه چیز از من برمی‌خیزد."},

  {stage:1,en:"I feel disconnected or unseen.",de:"Ich fühle mich getrennt oder ungesehen.",fa:"من احساس جدایی یا نادیده گرفته شدن می‌کنم."},
  {stage:2,en:"I feel glimpses of unity and flow.",de:"Ich spüre Momente der Einheit und des Flusses.",fa:"من لحظاتی از وحدت و جریان را تجربه می‌کنم."},
  {stage:3,en:"I live without striving; I am being.",de:"Ich lebe ohne Anstrengung; ich bin.",fa:"من بدون تلاش زندگی می‌کنم؛ من هستم."},

  {stage:1,en:"I was created.",de:"Ich wurde erschaffen.",fa:"من خلق شده‌ام."},
  {stage:2,en:"I am questioning creation.",de:"Ich hinterfrage die Schöpfung.",fa:"من در مورد خلقت سؤال می‌کنم."},
  {stage:3,en:"I am the only creator.",de:"Ich bin der einzige Schöpfer.",fa:"من تنها خالق هستم."},

  {stage:1,en:"There is someone or something out there.",de:"Da ist jemand oder etwas da draußen.",fa:"کسی یا چیزی در بیرون وجود دارد."},
  {stage:2,en:"Is there anyone out there?",de:"Gibt es jemanden da draußen?",fa:"آیا کسی در بیرون هست؟"},
  {stage:3,en:"There is no one; only I experience myself.",de:"Es ist niemand da; nur ich erlebe mich selbst.",fa:"هیچ‌کس نیست؛ تنها من خودم را تجربه می‌کنم."},

  {stage:1,en:"Someone has built the wall.",de:"Jemand hat die Mauer gebaut.",fa:"کسی دیوار را ساخته است."},
  {stage:2,en:"I am a brick in the wall.",de:"Ich bin ein Ziegel in der Mauer.",fa:"من یک آجر در دیوار هستم."},
  {stage:3,en:"I am the wall, shaping it constantly.",de:"Ich bin die Mauer, die sie ständig formt.",fa:"من دیوار هستم و آن را دائماً شکل می‌دهم."},

  {stage:1,en:"Somebody has built the road.",de:"Jemand hat die Straße gebaut.",fa:"کسی جاده را ساخته است."},
  {stage:2,en:"Who built the road?",de:"Wer hat die Straße gebaut?",fa:"چه کسی جاده را ساخته است؟"},
  {stage:3,en:"As I walk, the road appears; all is my creation.",de:"Während ich gehe, erscheint die Straße; alles ist meine Schöpfung.",fa:"همان‌طور که راه می‌روم، جاده ظاهر می‌شود؛ همه چیز خلق من است."},

  {stage:1,en:"I feel powerless to change what happens.",de:"Ich fühle mich machtlos, das Geschehen zu ändern.",fa:"من قدرت تغییر آنچه اتفاق می‌افتد را ندارم."},
  {stage:2,en:"I am the change; I need to act.",de:"Ich bin die Veränderung; ich muss handeln.",fa:"من تغییر هستم؛ باید عمل کنم."},
  {stage:3,en:"I hold no resistance; all is perfectly aligned with me.",de:"Ich widerstehe nichts; alles ist perfekt mit mir ausgerichtet.",fa:"من هیچ مقاومتی ندارم؛ همه چیز کاملاً با من هماهنگ است."},

  {stage:1,en:"I believe luck or fate decides outcomes.",de:"Ich glaube, Glück oder Schicksal entscheidet die Ergebnisse.",fa:"من باور دارم شانس یا سرنوشت نتایج را تعیین می‌کند."},
  {stage:2,en:"I trust life more than I resist it.",de:"Ich vertraue dem Leben mehr, als dass ich Widerstand leiste.",fa:"من به زندگی بیشتر از مقاومت اعتماد می‌کنم."},
  {stage:3,en:"I radiate fairness; all outcomes flow through me.",de:"Ich strahle Gerechtigkeit aus; alle Ergebnisse fließen durch mich.",fa:"من عدالت می‌تابانم؛ همه نتایج از طریق من جریان دارند."},

  {stage:1,en:"I see others as separate beings on their own journey.",de:"Ich sehe andere als separate Wesen auf ihrem eigenen Weg.",fa:"من دیگران را موجودات جداگانه در مسیر خود می‌بینم."},
  {stage:2,en:"I see others as mirrors, reflecting and teaching me.",de:"Ich sehe andere als Spiegel, die mich reflektieren und lehren.",fa:"من دیگران را به‌عنوان آیینه‌ای می‌بینم که بازتاب می‌دهند و به من آموزش می‌دهند."},
  {stage:3,en:"I see others only as shadows I create; only characters I allow.",de:"Ich sehe andere nur als Schatten, die ich erschaffe; nur Figuren, die ich erlaube.",fa:"من دیگران را تنها به‌عنوان سایه‌هایی که خلق می‌کنم می‌بینم؛ فقط شخصیت‌هایی که اجازه می‌دهم."},

  {stage:1,en:"I fear losing control.",de:"Ich habe Angst, die Kontrolle zu verlieren.",fa:"من از دست دادن کنترل می‌ترسم."},
  {stage:2,en:"I see no separation between creation and creator.",de:"Ich sehe keine Trennung zwischen Schöpfung und Schöpfer.",fa:"من جدایی بین خلق و خالق را نمی‌بینم."},
  {stage:3,en:"There are no others; only I experience my creation.",de:"Es gibt keine anderen; nur ich erlebe meine Schöpfung.",fa:"هیچ دیگری وجود ندارد؛ تنها من خلق خود را تجربه می‌کنم."},

  {stage:1,en:"There is God.",de:"Es gibt Gott.",fa:"خدا وجود دارد."},
  {stage:2,en:"Is there a God?",de:"Gibt es einen Gott?",fa:"آیا خدایی وجود دارد؟"},
  {stage:3,en:"There is no God; only I exist.",de:"Es gibt keinen Gott; nur ich existiere.",fa:"خدایی وجود ندارد؛ تنها من هستم."},

  {stage:1,en:"I need to belong to feel whole.",de:"Ich muss dazugehören, um mich vollständig zu fühlen.",fa:"من نیاز دارم تعلق داشته باشم تا کامل باشم."},
  {stage:2,en:"I am not alone; I belong.",de:"Ich bin nicht allein; ich gehöre dazu.",fa:"من تنها نیستم؛ تعلق دارم."},
  {stage:3,en:"I am alone; the only one.",de:"Ich bin allein; der Einzige.",fa:"من تنها هستم؛ تنها یک موجود."},

  {stage:1,en:"I often compare myself to others.",de:"Ich vergleiche mich oft mit anderen.",fa:"من اغلب خود را با دیگران مقایسه می‌کنم."},
  {stage:2,en:"I recognize reflections in others.",de:"Ich erkenne Spiegelungen in anderen.",fa:"من بازتاب‌ها را در دیگران تشخیص می‌دهم."},
  {stage:3,en:"I know love as my natural state.",de:"Ich kenne Liebe als meinen natürlichen Zustand.",fa:"من عشق را به‌عنوان حالت طبیعی خود می‌شناسم."},

  {stage:1,en:"I think peace depends on circumstances.",de:"Ich glaube, Frieden hängt von den Umständen ab.",fa:"من فکر می‌کنم صلح به شرایط بستگی دارد."},
  {stage:2,en:"I begin to see love behind appearances.",de:"Ich beginne, Liebe hinter Erscheinungen zu sehen.",fa:"من شروع می‌کنم عشق پشت ظاهرها را ببینم."},
  {stage:3,en:"I am love observing myself.",de:"Ich bin die Liebe, die sich selbst beobachtet.",fa:"من عشق هستم که خود را مشاهده می‌کنم."},

  {stage:1,en:"I hold resentment or blame.",de:"Ich hege Groll oder Schuldgefühle.",fa:"من دلخوری یا سرزنش دارم."},
  {stage:2,en:"I begin forgiving and letting go.",de:"Ich beginne zu vergeben und loszulassen.",fa:"من شروع می‌کنم به بخشیدن و رها کردن."},
  {stage:3,en:"I understand nothing is missing; all is integrated in me.",de:"Ich verstehe, dass nichts fehlt; alles ist in mir integriert.",fa:"من می‌فهمم هیچ چیزی کم نیست؛ همه چیز در من یکپارچه است."},

  {stage:1,en:"There is hell and heaven.",de:"Es gibt Himmel und Hölle.",fa:"جهنم و بهشت وجود دارد."},
  {stage:2,en:"Hell and heaven are states of being.",de:"Himmel und Hölle sind Zustände des Seins.",fa:"جهنم و بهشت حالت‌های هستی هستند."},
  {stage:3,en:"There is no hell or heaven; only I experience myself.",de:"Es gibt kein Himmel oder Hölle; nur ich erlebe mich selbst.",fa:"هیچ جهنم یا بهشتی وجود ندارد؛ تنها من خودم را تجربه می‌کنم."},

  {stage:1,en:"There is always someone to blame for events or my experience.",de:"Es gibt immer jemanden, dem man die Schuld geben kann.",fa:"همیشه کسی برای سرزنش وجود دارد."},
  {stage:2,en:"I only blame myself for what I experience.",de:"Ich gebe nur mir selbst die Schuld für das, was ich erlebe.",fa:"من تنها خودم را برای آنچه تجربه می‌کنم سرزنش می‌کنم."},
  {stage:3,en:"I blame no one; all arises from me.",de:"Ich gebe niemandem die Schuld; alles entsteht aus mir.",fa:"من کسی را سرزنش نمی‌کنم؛ همه چیز از من برمی‌خیزد."},

  {stage:1,en:"I need to be acknowledged.",de:"Ich muss anerkannt werden.",fa:"من نیاز دارم که به رسمیت شناخته شوم."},
  {stage:2,en:"I question whether acknowledgement matters.",de:"Ich hinterfrage, ob Anerkennung wichtig ist.",fa:"من می‌پرسم آیا به رسمیت شناختن مهم است؟"},
  {stage:3,en:"I am acknowledgement.",de:"Ich bin Anerkennung.",fa:"من خودم رسمیت هستم."},

  {stage:1,en:"I am constantly judging others.",de:"Ich urteile ständig über andere.",fa:"من مدام دیگران را قضاوت می‌کنم."},
  {stage:2,en:"I try not to judge, but I judge myself.",de:"Ich versuche nicht zu urteilen, aber ich urteile über mich selbst.",fa:"من سعی می‌کنم قضاوت نکنم، اما خودم را قضاوت می‌کنم."},
  {stage:3,en:"There is no judgment.",de:"Es gibt kein Urteil.",fa:"قضاوتی وجود ندارد."},

  {stage:1,en:"There is a history before me.",de:"Es gibt eine Geschichte vor mir.",fa:"تاریخی قبل از من وجود دارد."},
  {stage:2,en:"I think there is a source giving all beings consciousness.",de:"Ich erkenne, dass es eine Quelle gibt, die allen Wesen Bewusstsein verleiht.",fa:"من می‌دانم منبعی وجود دارد که به همه موجودات آگاهی می‌دهد."},
  {stage:3,en:"Time is an illusion; everything is in the now.",de:"Zeit ist eine Illusion; alles existiert im Jetzt.",fa:"زمان توهم است؛ همه چیز در اکنون است."},

  {stage:1,en:"Life is being projected to me.",de:"Das Leben wird mir projiziert.",fa:"زندگی برای من تجسم می‌شود."},
  {stage:2,en:"Reality is a co-creation; I am projecting and being projected.",de:"Die Realität ist eine Mit-Schöpfung; ich projiziere und werde projiziert.",fa:"واقعیت یک هم‌آفرینی است؛ من پروژه می‌کنم و پروژه می‌شوم."},
  {stage:3,en:"Let there be light; I only project my thoughts and feelings.",de:"Es werde Licht; ich projiziere nur meine Gedanken und Gefühle.",fa:"بگذار نور باشد؛ من فقط افکار و احساسات خود را تجسم می‌کنم."},

  {stage:1,en:"I perceive reality as external and separate from me.",de:"Ich nehme die Realität als extern und getrennt von mir wahr.",fa:"من واقعیت را جدا و بیرونی نسبت به خود می‌بینم."},
  {stage:2,en:"I recognize that my perception shapes what I call reality.",de:"Ich erkenne, dass meine Wahrnehmung formt, was ich Realität nenne.",fa:"من می‌دانم که ادراک من آنچه واقعیت می‌نامم را شکل می‌دهد."},
  {stage:3,en:"All reality is my own consciousness; I am both observer and observed.",de:"Alle Realität ist mein eigenes Bewusstsein; ich bin Beobachter und Beobachtetes.",fa:"همه واقعیت آگاهی خود من است؛ من هم ناظر و هم مشاهده‌شده هستم."},

  {stage:1,en:"I am influenced by past experiences and patterns.",de:"Ich bin von vergangenen Erfahrungen und Mustern beeinflusst.",fa:"من تحت تأثیر تجربیات و الگوهای گذشته هستم."},
  {stage:2,en:"I see the threads of causality and my participation in them.",de:"Ich sehe die Fäden der Kausalität und meine Beteiligung daran.",fa:"من تارهای علیت و مشارکت خود را در آنها می‌بینم."},
  {stage:3,en:"I am timeless; all causes and effects are me, fully present.",de:"Ich bin zeitlos; alle Ursachen und Wirkungen sind ich, vollständig präsent.",fa:"من بی‌زمان هستم؛ همه علل و معلول‌ها من هستم، کاملاً حاضر."},

  {stage:1,en:"I seek answers outside myself.",de:"Ich suche Antworten außerhalb von mir.",fa:"من دنبال پاسخ بیرون از خودم می‌گردم."},
  {stage:2,en:"I begin to find truth within my own awareness.",de:"Ich beginne, Wahrheit in meinem eigenen Bewusstsein zu finden.",fa:"من شروع به یافتن حقیقت در آگاهی خود می‌کنم."},
  {stage:3,en:"All knowing arises within me; there is no outside, only insight.",de:"Alles Wissen entsteht in mir; هیچ بیرونی وجود ندارد، تنها بینش هست.",fa:"همه دانایی درون من پدید می‌آید؛ هیچ بیرونی وجود ندارد، فقط بینش است."},

  {stage:1,en:"I feel bound by limitations of body and mind.",de:"Ich fühle mich durch Körper- und Geistesgrenzen gebunden.",fa:"من محدود به محدودیت‌های بدن و ذهن هستم."},
  {stage:2,en:"I sense the expansion beyond perceived limits.",de:"Ich spüre die Ausdehnung über wahrgenommene Grenzen hinaus.",fa:"من گسترش فراتر از مرزهای درک‌شده را حس می‌کنم."},
  {stage:3,en:"I exist beyond all limitations; I am infinite presence.",de:"Ich existiere jenseits aller Begrenzungen; ich bin unendliche Präsenz.",fa:"من فراتر از همه محدودیت‌ها وجود دارم؛ من حضور بی‌نهایت هستم."},

  {stage:1,en:"I judge and label what I experience.",de:"Ich urteile und etikettiere, was ich erfahre.",fa:"من تجربه‌هایم را قضاوت و برچسب می‌زنم."},
  {stage:2,en:"I witness my judgments and release them.",de:"Ich beobachte meine Urteile und lasse sie los.",fa:"من قضاوت‌های خود را مشاهده می‌کنم و رها می‌کنم."},
  {stage:3,en:"I am the pure witness; all distinctions are reflections of my own mind.",de:"Ich bin der reine Zeuge; alle Unterschiede sind Spiegelungen meines eigenen Geistes.",fa:"من شاهد مطلق هستم؛ همه تمایزات بازتاب ذهن خودم هستند."}
];

/* ====================================================================
   LOCALIZED LONG STAGE TEXTS & INTEGRATED SCORING NOTES
   These texts include:
   - full stage description
   - scoring interpretation (low/around5/high)
   - integrated scoring notes and result-determination logic
   ==================================================================== */
const STAGE_FULL = [
  /* Stage I full description */
  {
    en: `Stage I — Victimhood.
Score range: 0–10.

Description:
Stage I is the realm of victimhood where the self feels distant from its origin and lost in a density of forgetfulness. Life appears to happen to you rather than through you. Identity is entangled with stories, blame, and resistance.

Scoring meaning:
• High score (close to 10): deep immersion in victimhood, strong identification with external narratives, high resistance. Immediate shadow work and self-inquiry are recommended.
• Around 5: partial awareness; glimpses of truth appear and movement toward Stage II is possible with focused inner work.
• Low score (below 5): early awakening signs; readiness to begin shadow integration and shift into Stage II.

How this affects overall state:
The overall state is determined by the stage with the highest average score. If Stage I is highest, the overall state will read as Victimhood. Other stage scores provide context: for example, a moderate Stage II score signals some awakening even if Stage I is dominant.`,
    de: `Stufe I — Opferbewusstsein.
Punkteskala: 0–10.

Beschreibung:
Stufe I ist das Reich des Opferbewusstseins, in dem das Selbst weit von seiner Quelle entfernt ist und in Dichte und Vergessenheit verloren scheint. Das Leben scheint dir zu widerfahren, anstatt durch dich zu geschehen. Identität ist in Geschichten, Schuldzuweisungen und Widerstand verstrickt.

Bedeutung der Werte:
• Hoher Wert (nahe 10): tiefe Verstrickung im Opferbewusstsein, starke Identifikation mit äußeren Erzählungen, hoher Widerstand. Dringende Arbeit an Schattenanteilen und Selbstbefragung empfohlen.
• Rund um 5: teilweise Bewusstwerdung; erste Wahrnehmungen ermöglichen den Übergang zu Stufe II durch gezielte innere Arbeit.
• Niedriger Wert (unter 5): frühe Anzeichen des Erwachens; Bereitschaft zur Integration und zum Übergang zu Stufe II.

Wie dies den Gesamtzustand beeinflusst:
Der Gesamtzustand wird durch die Stufe mit dem höchsten Durchschnittswert bestimmt. Ist Stufe I am höchsten, lautet der Gesamtbefund Opferbewusstsein. Andere Stufenwerte liefern Nuancen.`,
    fa: `مرحله اول — قربانی بودن.
محدوده نمره: ۰–۱۰.

شرح:
مرحله اول قلمروی قربانی بودن است؛ خود از خاستگاه خود دور به‌نظر می‌رسد و در چگالی فراموشی گم شده است. زندگی به نظر می‌رسد برای شما اتفاق می‌افتد نه از طریق شما. هویت در داستان‌ها، سرزنش و مقاومت درگیر است.

معنای نمره:
• نمره بالا (نزدیک ۱۰): غرق شدن عمیق در حالت قربانی؛ شناسایی قوی با روایت‌های بیرونی و مقاومت بالا. کار سایه و خودپرسشی ضروری است.
• حدود ۵: آگاهی جزئی؛ نفوذهای حقیقی آغاز می‌شود و امکان حرکت به مرحله دوم با کار درونی وجود دارد.
• نمره پایین (زیر ۵): نشانه‌های بیداری اولیه؛ آمادگی برای یکپارچه‌سازی سایه‌ها و گذار به مرحله دوم.

چگونه بر وضعیت کلی تاثیر می‌گذارد:
وضعیت کلی توسط مرحله‌ای تعیین می‌شود که بیشترین میانگین نمره را دارد. اگر مرحله اول بالاترین باشد، وضعیت کلی قربانی بودن خوانده می‌شود. نمرات دیگر زمینه و جهت‌گیری را نشان می‌دهند.`
  },

  /* Stage II full description */
  {
    en: `Stage II — Awakening.
Score range: 0–10.

Description:
Stage II is the field of questioning, pattern recognition and expanded self-awareness. Here the self detects its projections, sees reflections in others, and begins to reshape its participation in reality.

Scoring meaning:
• High score (close to 10): strong engagement in inward work and questioning; balance is crucial — integration of emotional regulation and polarity before full authorship is necessary.
• Around 5: productive balance — lessons are integrating and the self is preparing for Stage III.
• Low score (below 5): signals readiness to transcend toward Stage III — integration is moving forward and authorship becomes accessible.

How this affects overall state:
If Stage II has the highest average, the overall state will read as Awakening. Note: when Stage II average is below 5, this indicates a readiness to move into Stage III — the system will reflect this as a recommendation to embrace authorship once integration is completed.`,
    de: `Stufe II — Erwachen.
Punkteskala: 0–10.

Beschreibung:
Stufe II ist das Feld des Fragens, der Mustererkennung und der erweiterten Selbstwahrnehmung. Hier erkennt das Selbst seine Projektionen, sieht Spiegelungen in anderen und beginnt, seine Teilhabe an der Realität umzustrukturieren.

Bedeutung der Werte:
• Hoher Wert (nahe 10): kraftvolle Beschäftigung mit innerer Arbeit und Fragestellung; Integration und Ausbalancierung sind entscheidend, bevor vollständige Autorenschaft möglich ist.
• Rund um 5: produktives Gleichgewicht — Lektionen werden integriert, das Selbst bereitet sich auf Stufe III vor.
• Niedriger Wert (unter 5): zeigt Bereitschaft zur Transzendenz in Richtung Stufe III — Integration schreitet voran und Schöpferbewusstsein wird zugänglich.

Wie dies den Gesamtzustand beeinflusst:
Ist Stufe II am höchsten, wird der Gesamtzustand als Erwachen ausgewiesen. Wenn der Durchschnitt von Stufe II unter 5 liegt, deutet dies auf unmittelbare Bereitschaft zur Entwicklung in Stufe III hin; das System gibt dann eine Empfehlung zur Integration und nächsten Schritten.`,
    fa: `مرحله دوم — بیداری.
محدوده نمره: ۰–۱۰.

شرح:
مرحله دوم میدان پرسشگری، شناسایی الگوها و گسترش خودآگاهی است. در اینجا خود، پروژه‌هایش را می‌بیند، بازتاب‌ها را در دیگران تشخیص می‌دهد و مشارکت خود در واقعیت را در حال بازآرایی می‌بیند.

معنای نمره:
• نمره بالا (نزدیک ۱۰): درگیری قوی در کار درونی و پرسشگری؛ برقراری تعادل ضروری است — یکپارچه‌سازی احساسات و قطب‌ها پیش از ظهور کامل نویسندگی لازم است.
• حدود ۵: تعادل سازنده — درس‌ها در حال یکپارچه شدن‌اند و خود برای مرحله سوم آماده می‌شود.
• نمره پایین (زیر ۵): نشانگر آمادگی برای گذار به مرحله سوم است — یکپارچه‌سازی جلو می‌رود و خلاقیت در دسترس قرار می‌گیرد.

چگونه بر وضعیت کلی تاثیر می‌گذارد:
اگر مرحله دوم بیشترین میانگین را داشته باشد، وضعیت کلی به‌عنوان بیداری خوانده می‌شود. اگر میانگین مرحله دوم زیر ۵ باشد، سیستم توصیه‌ای برای آماده‌سازی به سوی مرحله سوم ارائه می‌دهد.`,
  },

  /* Stage III full description */
  {
    en: `Stage III — Authorship.
Score range: 0–10.

Description:
Stage III is full authorship and source-awareness. The self recognizes itself as the author of experience, transcending linear time and witnessing reality as a unified field of consciousness.

Scoring meaning:
• High score (close to 10): active multidimensional expansion and mastery; authorship is primary.
• Around 5: balanced awareness — inner stability and integration are maintained while expansion continues.
• Low score (below 5): partial expansion; stabilization and balance are still required before full authorship stabilizes.

How this affects overall state:
If Stage III is the highest average, the overall state is Authorship. If Stage III is high but other stages show pockets of unresolved material, those areas are highlighted in the detailed notes below.`,
    de: `Stufe III — Autorenschaft.
Punkteskala: 0–10.

Beschreibung:
Stufe III steht für vollständige Autorenschaft und Quellenbewusstsein. Das Selbst erkennt sich als Schöpfer der Erfahrung, überschreitet lineare Zeit und erlebt Realität als einheitliches Feld des Bewusstseins.

Bedeutung der Werte:
• Hoher Wert (nahe 10): aktive multidimensionale Expansion und Meisterschaft; Autorenschaft ist dominierend.
• Rund um 5: ausgewogene Wahrnehmung — innere Stabilität und Integration sind bewahrt, während Expansion fortschreitet.
• Niedriger Wert (unter 5): teilweise Expansion; Stabilisierung und Ausbalancierung sind noch erforderlich, bevor Autorenschaft gefestigt ist.

Wie dies den Gesamtzustand beeinflusst:
Wenn Stufe III den höchsten Durchschnitt hat, ist der Gesamtzustand Autorenschaft. Zeigen sich jedoch in den anderen Stufen ungelöste Themen, werden diese im Detail hervorgehoben.`,
    fa: `مرحله سوم — نویسندگی.
محدوده نمره: ۰–۱۰.

شرح:
مرحله سوم نویسندگی کامل و آگاهی از منبع است. خود خود را به‌عنوان نویسندهٔ تجربه می‌شناسد، زمان خطی را فراتر می‌برد و واقعیت را به‌صورت یک میدان یکپارچه آگاهی تجربه می‌کند.

معنای نمره:
• نمره بالا (نزدیک ۱۰): گسترش چندبعدی فعال و استادی؛ نویسندگی برجسته است.
• حدود ۵: آگاهی متعادل — ثبات درونی و یکپارچگی در حالی که گسترش ادامه دارد حفظ می‌شود.
• نمره پایین (زیر ۵): گسترش جزئی؛ تثبیت و تعادل هنوز لازم است تا نویسندگی کامل تثبیت شود.

چگونه بر وضعیت کلی تاثیر می‌گذارد:
اگر مرحله سوم بالاترین میانگین را داشته باشد، وضعیت کلی نویسندگی است. اگرچه اگر سطوح دیگری مناطق حل‌نشده‌ای نشان دهند، این موارد در یادداشت‌های تفصیلی آورده می‌شوند.`
  }
];

/* Summarized integrated scoring notes (localized) - presented in the dominant box too */
const INTEGRATED_NOTES = {
  en: `Integrated scoring logic:
• Each stage is scored 0–10. The stage with the highest average determines the overall state.
• Score interpretation:
  - <5 indicates readiness to integrate or move toward the next stage (where applicable).
  - ≈5 indicates balance/equilibrium.
  - >5 indicates active immersion or expansion.
• If two stages are close, the later (higher) stage is favored to encourage growth orientation.
Use the per-stage panels to read detailed guidance and precise next steps.`,
  de: `Integrierte Bewertungslogik:
• Jede Stufe wird 0–10 bewertet. Die Stufe mit dem höchsten Durchschnitt bestimmt den Gesamtzustand.
• Bedeutungen der Werte:
  - <5 zeigt Bereitschaft zur Integration oder zum Übergang (wo zutreffend).
  - ≈5 zeigt Gleichgewicht / Ausgewogenheit.
  - >5 zeigt aktive Verankerung oder Expansion.
• Bei ähnlichen Werten wird die spätere Stufe bevorzugt, um wachstumsorientierte Lesungen zu unterstützen.
Nutze die einzelnen Stufen-Panels für detaillierte Anleitungen und nächste Schritte.`,
  fa: `منطق امتیازدهی یکپارچه:
• هر مرحله از ۰ تا ۱۰ نمره می‌گیرد. مرحله‌ای که میانگین بالاتری دارد، وضعیت کلی را تعیین می‌کند.
• تفسیر نمره:
  - <۵ نشان‌دهندهٔ آمادگی برای یکپارچه‌سازی یا گذار به مرحله بعد است (در صورت کاربرد).
  - ≈۵ نشان‌دهندهٔ تعادل/توازی است.
  - >۵ نشان‌دهندهٔ درگیری فعال یا گسترش است.
• اگر دو مرحله نزدیک باشند، مرحله بالاتر ارجحیت دارد تا خوانش رشدمحور را تشویق کند.
برای راهنمایی دقیق‌تر و گام‌های بعدی از پنل‌های هر مرحله استفاده کنید.`
};

/* -------------------------
   Elements & state
   ------------------------- */
const root = document.documentElement;
const pageTitle = document.getElementById('pageTitle');
const langRow = document.getElementById('langRow');
const langSelect = document.getElementById('langSelect');
const landingPane = document.getElementById('landingPane');
const questionPane = document.getElementById('questionPane');
const resultPane = document.getElementById('resultPane');
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const restartBtn = document.getElementById('restartBtn');
const landingText = document.getElementById('landingText');
const landingLabels = {left:document.getElementById('lblLeft'), mid:document.getElementById('lblMid'), right:document.getElementById('lblRight')};
const questionLabels = {left:document.getElementById('qLblLeft'), mid:document.getElementById('qLblMid'), right:document.getElementById('qLblRight')};
const landingSlider = document.getElementById('landingSlider');
const questionSlider = document.getElementById('questionSlider');
const questionText = document.getElementById('questionText');
const scoreI = document.getElementById('scoreI');
const scoreII = document.getElementById('scoreII');
const scoreIII = document.getElementById('scoreIII');
const dominantBox = document.getElementById('dominantBox');

const stageIButton = document.getElementById('stageIButton');
const stageIIButton = document.getElementById('stageIIButton');
const stageIIIButton = document.getElementById('stageIIIButton');

const stageIDetails = document.getElementById('stageIDetails');
const stageIIDetails = document.getElementById('stageIIDetails');
const stageIIIDetails = document.getElementById('stageIIIDetails');

const stageIContent = document.getElementById('stageIContent');
const stageIIContent = document.getElementById('stageIIContent');
const stageIIIContent = document.getElementById('stageIIIContent');

let lang = 'en';
let order = [];
let idx = 0;
let answers = []; // array of {stage, value}

/* --- localization small helpers for labels --- */
function setRTL(flag){ root.setAttribute('dir', flag ? 'rtl' : 'ltr'); }
function localizeLabels(){
  const map = {
    en: {left:"Disagree", mid:"Uncertain", right:"Agree", start:"Start", next:"Next", restart:"Restart", landingDesc:"This is a reflection of my inner consciousness called Spectrum of Awareness. I am answering a series of statements using the slider to indicate my agreement."},
    de: {left:"Ablehnen", mid:"Ungewiss", right:"Zustimmen", start:"Start", next:"Weiter", restart:"Neu starten", landingDesc:"Dies ist eine Reflexion meines inneren Bewusstseins, genannt Spektrum des Bewusstseins. Ich beantworte eine Reihe von Aussagen mit dem Schieberegler."},
    fa: {left:"مخالف", mid:"مردد", right:"موافق", start:"شروع", next:"بعدی", restart:"دوباره", landingDesc:"این بازتاب آگاهی درونی من به نام طیف آگاهی است. من به مجموعه‌ای از جملات پاسخ می‌دهم و با استفاده از نوار لغزنده میزان موافقت را مشخص می‌کنم."}
  }[lang];
  landingLabels.left.textContent = map.left;
  landingLabels.mid.textContent = map.mid;
  landingLabels.right.textContent = map.right;
  questionLabels.left.textContent = map.left;
  questionLabels.mid.textContent = map.mid;
  questionLabels.right.textContent = map.right;
  startBtn.textContent = map.start;
  nextBtn.textContent = map.next;
  restartBtn.textContent = map.restart;
  landingText.textContent = map.landingDesc;
  pageTitle.textContent = (lang==='de' ? 'Spektrum des Bewusstseins' : lang==='fa' ? 'طیف آگاهی' : 'Spectrum of Awareness');
}

/* initialize localization */
langSelect.value = lang;
setRTL(false);
localizeLabels();

/* language change */
langSelect.addEventListener('change', (e)=>{
  lang = e.target.value;
  setRTL(lang === 'fa');
  localizeLabels();
});

/* Start quiz - same as original */
startBtn.addEventListener('click', ()=>{
  pageTitle.style.display = 'none';
  langRow.style.display = 'none';
  order = QUESTIONS.map((_,i)=>i).sort(()=>Math.random()-0.5);
  idx = 0;
  answers = [];
  landingPane.classList.add('hidden');
  resultPane.classList.add('hidden');
  questionPane.classList.remove('hidden');
  showQuestion();
});

/* show question */
function showQuestion(){
  const qIdx = order[idx];
  const q = QUESTIONS[qIdx];
  questionText.textContent = q[lang] || q.en;
  questionSlider.value = 5;
  questionText.scrollIntoView({behavior:'smooth', block:'center'});
}

/* Next - record answer and advance */
nextBtn.addEventListener('click', ()=>{
  const v = Number(questionSlider.value || 5);
  const qIdx = order[idx];
  answers.push({stage:QUESTIONS[qIdx].stage, value:v});
  idx++;
  if(idx >= order.length){
    questionPane.classList.add('hidden');
    pageTitle.style.display = '';
    resultPane.classList.remove('hidden');
    computeResult(); // new compute & render logic
  } else {
    showQuestion();
  }
});

/* Restart */
restartBtn.addEventListener('click', ()=>{
  resultPane.classList.add('hidden');
  landingPane.classList.remove('hidden');
  pageTitle.style.display = '';
  langRow.style.display = '';
  landingSlider.value = 5;
});

/* Utility: open/close stage panels */
function openPanel(panel){
  // close others
  [stageIDetails, stageIIDetails, stageIIIDetails].forEach(p=>{
    if(p !== panel) p.classList.remove('open');
  });
  panel.classList.toggle('open');
}

/* Hook buttons */
stageIButton.addEventListener('click', ()=> openPanel(stageIDetails));
stageIIButton.addEventListener('click', ()=> openPanel(stageIIDetails));
stageIIIButton.addEventListener('click', ()=> openPanel(stageIIIDetails));

document.querySelectorAll('.closeBtn').forEach(b=>{
  b.addEventListener('click', (e)=>{
    const sel = e.currentTarget.getAttribute('data-close');
    const el = document.getElementById(sel);
    if(el) el.classList.remove('open');
  });
});

/* -------------------------
   computeResult: updated to reflect your rules
   - compute per-stage averages
   - determine dominant stage (highest avg; ties -> later stage)
   - compute readiness/balance notes and show them
   - populate stage detail panels with full localized long text + dynamic score notes
   ------------------------- */
function computeResult(){
  // 1. per-stage average
  const sums = [0,0,0];
  const counts = [0,0,0];
  answers.forEach(a=>{
    const s = a.stage - 1; // 0-based
    if(s>=0 && s<3){ sums[s] += a.value; counts[s]++; }
  });
  const avgs = [0,0,0];
  for(let i=0;i<3;i++){ avgs[i] = counts[i] ? (sums[i]/counts[i]) : 0; }

  // 2. show numeric
  scoreI.textContent = avgs[0].toFixed(1);
  scoreII.textContent = avgs[1].toFixed(1);
  scoreIII.textContent = avgs[2].toFixed(1);

  // 3. determine dominant stage (highest average; if tie, later stage wins)
  let highest = 0;
  if(avgs[1] > avgs[highest]) highest = 1;
  if(avgs[2] > avgs[highest]) highest = 2;
  if(avgs[1] === avgs[highest] && highest !== 1 && avgs[1] === avgs[2]) { highest = Math.max(highest, 2); }

  // 4. prepare contextual notes based on thresholds
  // threshold logic:
  // - score <5 => readiness/integration required (promotes movement if stage is preceding)
  // - score == ~5 => balanced
  // - score >5 => active immersion/expansion

  function interpretScore(stageIndex, score){
    const res = {label:'', note:''};
    if(score < 5) res.label = (lang==='de' ? 'Unter 5' : lang==='fa' ? 'کمتر از ۵' : 'Below 5');
    else if(Math.abs(score - 5) < 0.4) res.label = (lang==='de' ? 'Um 5' : lang==='fa' ? 'حدود ۵' : 'Around 5');
    else res.label = (lang==='de' ? 'Über 5' : lang==='fa' ? 'بیشتر از ۵' : 'Above 5');

    // stage-specific dynamic notes
    if(stageIndex === 0){
      // Stage I victims
      if(score >= 8) res.note = (lang==='de' ? 'Tiefe Verstrickung im Opferbewusstsein. Dringende Schattenarbeit empfohlen.' : lang==='fa' ? 'درگیری عمیق با حالت قربانی؛ کار سایه فوری لازم است.' : 'Deep immersion in victimhood; urgent shadow work recommended.');
      else if(score >= 5) res.note = (lang==='de' ? 'Verletzlichkeit und Identifikation. Arbeit an Selbstvergebung hilfreich.' : lang==='fa' ? 'آسیب‌پذیری و همپوشانی هویت؛ کار روی خودبخشش مفید است.' : 'Vulnerability and identification. Self-forgiveness work helpful.');
      else res.note = (lang==='de' ? 'Anfänge des Erwachens. Möglichkeit des Übergangs zu Stufe II.' : lang==='fa' ? 'آغاز بیداری؛ امکان گذار به مرحله دوم وجود دارد.' : 'Beginnings of awakening; possible move to Stage II.');
    } else if(stageIndex === 1){
      if(score < 5) res.note = (lang==='de' ? 'Bereit zur Transzendenz in Richtung Stufe III.' : lang==='fa' ? 'آمادگی گذار به مرحله سوم.' : 'Readiness to transcend toward Stage III.');
      else if(score <= 7) res.note = (lang==='de' ? 'Wachsendes Bewusstsein; Integration empfohlen.' : lang==='fa' ? 'گسترش آگاهی؛ یکپارچه‌سازی توصیه می‌شود.' : 'Growing awareness; integration recommended.');
      else res.note = (lang==='de' ? 'Starke Fragebereitschaft; Balance vor Autorenschaft einüben.' : lang==='fa' ? 'پرسشگری قوی؛ باید قبل از نویسندگی تعادل برقرار شود.' : 'Strong questioning; practice balance before full authorship.');
    } else {
      // Stage III
      if(score >= 8) res.note = (lang==='de' ? 'Aktive multidimensionale Expansion; Meisterschaft sichtbar.' : lang==='fa' ? 'گسترش چندبعدی فعال؛ نشانه‌های تسلط.' : 'Active multidimensional expansion; mastery visible.');
      else if(score >= 5) res.note = (lang==='de' ? 'Gleichgewicht erreicht; Integration stabil.' : lang==='fa' ? 'تعادل برقرار؛ یکپارچگی تثبیت شده.' : 'Balance attained; integration stabilizing.');
      else res.note = (lang==='de' ? 'Teilweise Expansion; Balance und Stabilisierung notwendig.' : lang==='fa' ? 'گسترش جزئی؛ نیاز به تثبیت و تعادل.' : 'Partial expansion; stabilization needed.');
    }
    return res;
  }

  const interpI = interpretScore(0, avgs[0]);
  const interpII = interpretScore(1, avgs[1]);
  const interpIII = interpretScore(2, avgs[2]);

  // 5. compose dominant box (localized)
  const dominantTitle = (lang==='de' ? ['Opferbewusstsein','Erwachen','Autorenschaft'][highest] : lang==='fa' ? ['قربانی بودن','بیداری','نویسندگی'][highest] : ['Victimhood','Awakening','Authorship'][highest]);
  const dominantText = STAGE_FULL[highest][lang] || STAGE_FULL[highest].en;

  // integrate numeric notes for clarity
  const noteLines = [];
  noteLines.push((lang==='de' ? 'Durchschnittswerte: ' : lang==='fa' ? 'میانگین‌ها: ' : 'Averages: ') +
                 `${(lang==='de'?'Stufe I':'Stage I')}: ${avgs[0].toFixed(1)}  |  ${(lang==='de'?'Stufe II':'Stage II')}: ${avgs[1].toFixed(1)}  |  ${(lang==='de'?'Stufe III':'Stage III')}: ${avgs[2].toFixed(1)}`);

  noteLines.push(INTEGRATED_NOTES[lang] || INTEGRATED_NOTES.en);

  // readiness hint: if Stage II below 5, add a recommendation about moving to Stage III
  if(avgs[1] < 5 && highest === 1){
    noteLines.push((lang==='de' ? 'Hinweis: Stufe II ist unter 5 — das System erkennt Bereitschaft zur Transzendenz in Richtung Stufe III.' : lang==='fa' ? 'توجه: میانگین مرحله دوم زیر ۵ است — سیستم آمادگی گذار به مرحله سوم را تشخیص می‌دهد.' : 'Note: Stage II is below 5 — the system recognizes readiness to transcend toward Stage III.'));
  }

  // if Stage I is dominant but low Stage II present, show potential to shift
  if(highest === 0 && avgs[0] > avgs[1] && avgs[1] < 5){
    noteLines.push((lang==='de' ? 'Trotzdominanz von Stufe I zeigen niedrigere Werte in Stufe II Potenzial für Wandel.' : lang==='fa' ? 'گرچه مرحله اول غالب است، ارزش‌های پایین‌تر در مرحله دوم پتانسیل تغییر را نشان می‌دهند.' : 'Although Stage I is dominant, lower Stage II values indicate potential for change.'));
  }

  // Render dominant box: title + short description + integrated notes
  dominantBox.innerHTML = `<strong>${dominantTitle}</strong><div style="margin-top:8px;">${(STAGE_FULL[highest][lang] || STAGE_FULL[highest].en).split('\n')[0]}</div>
  <div style="margin-top:10px;font-size:13px;color:#444;white-space:pre-wrap;">${noteLines.join('\n\n')}</div>`;

  // 6. populate stage detail panels with full text + dynamic score interpretations
  const assemblePanelContent = (stageIndex, avg, interp) => {
    const header = (lang==='de' ? `Punktestand: ${avg.toFixed(1)}` : lang==='fa' ? `امتیاز: ${avg.toFixed(1)}` : `Score: ${avg.toFixed(1)}`);
    const dyn = `${(lang==='de' ? 'Bedeutung:' : lang==='fa' ? 'معنی:' : 'Interpretation:')} ${interp.label} — ${interp.note}`;
    const full = STAGE_FULL[stageIndex][lang] || STAGE_FULL[stageIndex].en;
    const nextSteps = (lang==='de' ? '\n\nNächste Schritte: Lies die Anleitungen in diesem Abschnitt und arbeite an Schattenintegration, Balance und Erinnerung an deine Autorenschaft.' :
                       lang==='fa' ? '\n\nقدم‌های بعدی: متن این بخش را بخوان و روی یکپارچه‌سازی سایه‌ها، تعادل و یادآوری نویسندگی خود کار کن.' :
                       '\n\nNext steps: Read the guidance in this panel and work on shadow integration, balance, and remembering your authorship.');
    return `<div style="font-weight:700;margin-bottom:8px;">${header}</div><div style="white-space:pre-wrap;">${full}</div><div style="margin-top:10px;font-weight:600;">${dyn}</div><div style="white-space:pre-wrap;margin-top:8px;color:#444;">${nextSteps}</div>`;
  };

  stageIContent.innerHTML = assemblePanelContent(0, avgs[0], interpI);
  stageIIContent.innerHTML = assemblePanelContent(1, avgs[1], interpII);
  stageIIIContent.innerHTML = assemblePanelContent(2, avgs[2], interpIII);

  // 7. finally, ensure all panels are collapsed initially
  [stageIDetails, stageIIDetails, stageIIIDetails].forEach(p=>p.classList.remove('open'));
}

/* Initialize sliders */
landingSlider.value = 5;
questionSlider.value = 5;
</script>
</body>
</html>
