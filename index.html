<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spectrum of Awareness</title>
<style>
  :root{
    --panel-width:760px;
    --accent:#666440;
    --bg:#f5f7fa;
    --card:#ffffff;
    --muted:#666;
    --text:#111;
  }
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
  }
  .wrap{
    min-height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:28px;
  }
  .panel{
    width:min(96%,var(--panel-width));
    max-width:var(--panel-width);
    background:var(--card);
    border-radius:14px;
    box-shadow:0 10px 30px rgba(20,20,30,0.06);
    padding:34px;
    box-sizing:border-box;
    text-align:center;
  }
  h1{
    margin:0 0 18px 0;
    font-weight:400;
    color:#444;
    font-size:22px;
  }
  .row{
    display:flex;
    justify-content:center;
    gap:12px;
    align-items:center;
    margin-bottom:20px;
  }
  select{
    padding:8px 12px;
    font-size:15px;
    border-radius:8px;
    border:1px solid #e6e6e6;
    background:white;
  }
  p.lead{
    margin:0 0 18px 0;
    color:#666;
    font-size:15px;
    line-height:1.45;
  }
  .fixed-slider-wrap{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    margin:18px 0 8px 0;
  }
  .fixed-track{
    width:92%;
    max-width:680px;
  }
  input[type="range"]{
    -webkit-appearance:none;
    width:100%;
    height:12px;
    border-radius:10px;
    background:#e6e6e6;
    outline:none;
    margin:0;
    padding:0;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:34px;
    height:18px;
    border-radius:9px;
    background:var(--accent);
    box-shadow:0 6px 18px rgba(102,100,64,0.24);
    border:2px solid white;
    margin-top:-3px;
    cursor:pointer;
  }
  input[type="range"]::-moz-range-thumb{
    width:34px;
    height:18px;
    border-radius:9px;
    background:var(--accent);
    box-shadow:0 6px 18px rgba(102,100,64,0.24);
    border:2px solid white;
    cursor:pointer;
  }
  .slider-labels{
    width:92%;
    max-width:680px;
    display:flex;
    justify-content:space-between;
    color:var(--muted);
    font-size:13px;
    margin-top:6px;
    user-select:none;
  }
  .btn{
    display:inline-block;
    padding:12px 28px;
    border-radius:28px;
    background:var(--accent);
    color:white;
    border:none;
    font-size:15px;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(102,100,64,0.18);
    margin-top:18px;
  }
  .btn:active{
    transform:translateY(1px);
  }
  .hidden{display:none;}
  .result-grid{
    margin-top:12px;
    color:#333;
    font-size:15px;
    display:flex;
    gap:12px;
    justify-content:space-between;
    align-items:center;
  }
  .result-stage{
    font-weight:700;
    flex:1;
    padding:10px;
    background:#fbfbfb;
    border-radius:10px;
    cursor:pointer;
    position:relative;
    transition:background 0.2s;
  }
  .result-stage:hover{
    background:#f0f0f0;
  }
  .result-score{
    font-size:18px;
    color:#222;
    margin-top:8px;
    font-weight:600;
  }
  .stage-desc{
    padding:12px 14px;
    margin-top:8px;
    background:#f9f9f9;
    border-radius:10px;
    text-align:left;
    font-size:14px;
    line-height:1.6;
    display:none;
    white-space:pre-wrap;
  }
  :root[dir="rtl"] .panel{
    direction:rtl;
  }
  :root[dir="rtl"] .slider-labels{
    direction:rtl;
  }
  #questionText{
    font-size:18px;
    line-height:1.45;
    margin:6px 0 14px 0;
    text-align:center;
    word-break:break-word;
  }
  footer.note{
    margin-top:14px;
    color:#666;
    font-size:13px;
  }
  #dominantMessage{
    margin-top:20px;
    background:#f8f8f8;
    border-radius:12px;
    padding:16px;
    color:#333;
    font-size:15px;
    line-height:1.4;
    box-shadow:0 6px 20px rgba(0,0,0,0.04);
  }
  #dominantMessage strong{
    color:var(--accent);
  }
  @media (max-width:520px){
    .panel{padding:20px;}
    #questionText{font-size:16px;}
    .btn{padding:10px 20px;}
  }
  :root[dir="rtl"] .stage-desc {
  direction: rtl;
  text-align: right;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" id="panel">

    <!-- Landing Page -->
    <div id="landingPane">
      <h1 id="pageTitle">Spectrum of Awareness</h1>
      <div class="row" id="langRow">
        <select id="langSelect">
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="fa">فارسی</option>
        </select>
      </div>
      <p class="lead" id="landingText">This is a reflection of my inner consciousness called Spectrum of Awareness.</p>
      <button id="startBtn" class="btn">Start</button>
    </div>

    <!-- Questionnaire Page -->
    <div id="questionPane" class="hidden">
      <!-- Minimalistic Dot Progress -->
      <div id="questionDots" style="display:flex;justify-content:center;gap:6px;margin-bottom:18px;"></div>
      <div id="questionText"></div>
      <div class="fixed-slider-wrap">
        <div class="fixed-track">
          <input id="questionSlider" type="range" min="0" max="10" value="5" />
        </div>
        <div class="slider-labels">
          <span id="qLblLeft">Disagree</span>
          <span id="qLblMid">Uncertain</span>
          <span id="qLblRight">Agree</span>
        </div>
      </div>
      <button id="nextBtn" class="btn">Next</button>
    </div>

    <!-- Result Page -->
    <div id="resultPane" class="hidden">
      <h1 id="resultTitle">Spectrum of Awareness</h1>
      <div class="result-grid">
        <div class="result-stage" id="stageI"><div>Stage I</div><div class="result-score" id="scoreI">0.0</div></div>
        <div class="result-stage" id="stageII"><div>Stage II</div><div class="result-score" id="scoreII">0.0</div></div>
        <div class="result-stage" id="stageIII"><div>Stage III</div><div class="result-score" id="scoreIII">0.0</div></div>
      </div>
      <div id="dominantMessage" class="hidden"></div>
      <div id="stageDetails"></div>
      <div id="overallResult" class="hidden" style="margin:24px 0; padding:20px; border-radius:16px; background:#f0f0f0; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,0.05); font-size:15px; line-height:1.5;"></div>
      <button id="restartBtn" class="btn">Restart</button>
      <footer class="note" id="footerNote"></footer>
    </div>

  </div>
</div>

<script>
// ----------------- QUESTIONS -----------------
const QUESTIONS = [ 
  {stage:1,en:"Life happens to me.",de:"Das Leben passiert mir.",fa:"زندگی برای من اتفاق می‌افتد."},
  {stage:2,en:"Life happens through me.",de:"Das Leben passiert durch mich.",fa:"زندگی از طریق من اتفاق می‌افتد."},
  {stage:3,en:"Life happens as me.",de:"Das Leben passiert als ich.",fa:"زندگی همان من است که رخ می‌دهد."},

  {stage:1,en:"I feel life is unfair or against me.",de:"Ich fühle, das Leben ist unfair oder gegen mich.",fa:"من احساس می‌کنم زندگی ناعادلانه است یا علیه من است."},
  {stage:2,en:"I notice patterns repeating and wonder why.",de:"Ich bemerke sich wiederholende Muster und frage mich warum.",fa:"من الگوهای تکراری را مشاهده می‌کنم و می‌پرسم چرا."},
  {stage:3,en:"I see all as one flow of consciousness.",de:"Ich sehe alles als einen Fluss des Bewusstseins.",fa:"من همه چیز را به‌عنوان یک جریان واحد آگاهی می‌بینم."},

  {stage:1,en:"I am the victim of life.",de:"Ich bin das Opfer des Lebens.",fa:"من قربانی زندگی هستم."},
  {stage:2,en:"I am connected to a source (higher self, God).",de:"Ich bin mit einer Quelle (höheres Selbst, Gott) verbunden.",fa:"من به یک منبع (خود برتر، خدا) متصل هستم."},
  {stage:3,en:"I am the only source; God is a concept within me.",de:"Ich bin die einzige Quelle; Gott ist ein Konzept in mir.",fa:"من تنها منبع هستم؛ خدا مفهومی درون من است."},
];

// ----------------- STAGE SUMMARY -----------------
const STAGE_SUMMARY = {
  1:{en:"I am in Stage I — Victimhood: life feels like it happens to me.",de:"Ich bin in Stufe I — Opferrolle: das Leben scheint mir zu widerfahren.",fa:"من در مرحله اول هستم — قربانی: زندگی را به‌عنوان چیزی که برایم اتفاق می‌افتد تجربه می‌کنم."},
  2:{en:"I am in Stage II — Awakening: life happens through me.",de:"Ich bin in Stufe II — Erwachen: das Leben geschieht durch mich.",fa:"من در مرحله دوم هستم — بیداری: زندگی از طریق من جریان دارد."},
  3:{en:"I am in Stage III — Mastery: life happens as me.",de:"Ich bin in Stufe III — Meisterschaft: das Leben geschieht als ich.",fa:"من در مرحله سوم هستم — تسلط: زندگی همان من است."}
};

// ----------------- STAGE INFO -----------------
const STAGE_INFO = [
  {
    title:{en:"Victimhood",de:"Opferrolle",fa:"قربانی"},
    description:{
      en:[
        "Stage I is the realm of victimhood, where I feel distant from my origin and lost in forgetfulness. Life is experienced as happening to me rather than through me.",
        "Close to 10:\nI am deeply immersed in victimhood; heavy attachment, resistance, and identification with external stories. Overall state dominated by Stage I.",
        "Around 5:\nPartial awareness emerges; glimpses of truth appear, potential to move toward Stage II.",
        "Close to 1:\nEarly awakening; I begin noticing patterns and reflections. Shadow work and self-inquiry required."
      ],
      de:[
        "Stufe I ist das Reich der Opferrolle, in dem ich mich von meiner Quelle entfernt und in Vergessenheit verloren fühle. Das Leben wird erlebt, als geschähe es mir, nicht durch mich.",
        "Close to 10:\nIch bin tief in der Opferhaltung; starke Bindung, Widerstand und Identifikation mit äußeren Geschichten. Gesamtzustand von Stufe I dominiert.",
        "Around 5:\nTeilweise aufkommendes Bewusstsein; Einblicke erscheinen, Potenzial für Stufe II.",
        "Close to 1:\nFrühes Erwachen; ich bemerke Muster und Spiegelungen. Schattenarbeit und Selbstreflexion erforderlich."
      ],
      fa:[
        "مرحله اول حوزه قربانی بودن است که در آن من احساس دوری از منبع خود دارم و در فراموشی گم شده‌ام. زندگی به‌عنوان چیزی که بر من رخ می‌دهد تجربه می‌شود، نه از طریق من.",
        "Close to 10:\nغرق شدن در قربانی بودن؛ وابستگی شدید، مقاومت و هویت با داستان‌های بیرونی. وضعیت کلی تحت سلطه مرحله اول.",
        "Around 5:\nآگاهی جزئی ظاهر می‌شود؛ درک‌هایی از حقیقت نمایان می‌شود، پتانسیل حرکت به سمت مرحله دوم.",
        "Close to 1:\nبیداری اولیه؛ من الگوها و بازتاب‌ها را متوجه می‌شوم. نیاز به کار سایه و خودکاوی."
      ]
    }
  },
  {
    title:{en:"Awakening",de:"Erwachen",fa:"بیداری"},
    description:{
      en:[
        "Stage II is the awakening stage. I begin noticing patterns, understanding my role as co-creator, and feeling connected to a greater flow. Awareness increases and judgment diminishes.",
        "Close to 10:\nHigh awareness, conscious decision-making; beginning integration of shadow and light.",
        "Around 5:\nGrowing insight; I am partially aware of patterns and influences.",
        "Close to 1:\nEarly awareness; I notice repetition, questioning begins."
      ],
      de:[
        "Stufe II ist die Erwachensstufe. Ich beginne Muster zu erkennen, meine Rolle als Mit-Schöpfer zu verstehen und mich mit einem größeren Fluss verbunden zu fühlen. Bewusstsein steigt, Urteilskraft nimmt ab.",
        "Close to 10:\nHohes Bewusstsein, bewusstes Entscheiden; Beginn der Integration von Schatten und Licht.",
        "Around 5:\nWachsende Einsicht; ich bin teilweise mir der Muster bewusst.",
        "Close to 1:\nFrühes Bewusstsein; ich bemerke Wiederholungen, Fragen beginnen."
      ],
      fa:[
        "مرحله دوم مرحله بیداری است. من شروع به مشاهده الگوها، درک نقش خود به‌عنوان هم‌آفریننده و احساس ارتباط با جریان بزرگتر می‌کنم. آگاهی افزایش می‌یابد و قضاوت کاهش می‌یابد.",
        "Close to 10:\nآگاهی بالا، تصمیم‌گیری آگاهانه؛ شروع یکپارچه‌سازی سایه و نور.",
        "Around 5:\nبینش در حال رشد؛ من تا حدی از الگوها و تأثیرات آگاه هستم.",
        "Close to 1:\nآگاهی اولیه؛ من تکرارها را می‌بینم، پرسش‌ها آغاز می‌شوند."
      ]
    }
  },
  {
    title:{en:"Mastery",de:"Meisterschaft",fa:"تسلط"},
    description:{
      en:[
        "Stage III is the stage of mastery and full integration. I know I am the only source; all experiences are reflections of my inner consciousness. There is no separation, only pure creation.",
        "Close to 10:\nComplete embodiment of mastery; life flows effortlessly through me.",
        "Around 5:\nIntegration in progress; glimpses of mastery and unity appear.",
        "Close to 1:\nEarly mastery signs; I experiment with full ownership and creation."
      ],
      de:[
        "Stufe III ist die Stufe der Meisterschaft und vollständigen Integration. Ich erkenne, dass ich die einzige Quelle bin; alle Erfahrungen sind Spiegelungen meines inneren Bewusstseins. Keine Trennung, nur reine Schöpfung.",
        "Close to 10:\nVollständige Verkörperung der Meisterschaft; das Leben fließt mühelos durch mich.",
        "Around 5:\nIntegration im Gange; Einblicke in Meisterschaft und Einheit erscheinen.",
        "Close to 1:\nFrühe Meisterschaftsanzeichen; ich experimentiere mit voller Verantwortung und Schöpfung."
      ],
      fa:[
        "مرحله سوم مرحله تسلط و یکپارچگی کامل است. من می‌دانم که تنها منبع هستم؛ همه تجربه‌ها بازتاب آگاهی درونی من هستند. هیچ جدایی وجود ندارد، فقط خلق خالص.",
        "Close to 10:\nتجسم کامل تسلط؛ زندگی به‌راحتی از طریق من جریان می‌یابد.",
        "Around 5:\nیکپارچه‌سازی در حال انجام؛ درک‌هایی از تسلط و وحدت ظاهر می‌شود.",
        "Close to 1:\nنشانه‌های اولیه تسلط؛ من با مالکیت کامل و خلق آزمایش می‌کنم."
      ]
    }
  }
];

// ----------------- LANGUAGE CONTROL -----------------
let currentLang = "en";
const langSelectEl = document.getElementById("langSelect");
langSelectEl.addEventListener("change", (e) => {
  currentLang = e.target.value;
  applyLanguage();
  if(currentQ<QUESTIONS.length && currentQ>=0) showQuestion();
  if(document.getElementById("resultPane").classList.contains("hidden")===false) showResults();
});

function applyLanguage(){
  document.documentElement.setAttribute('dir', currentLang === "fa" ? "rtl" : "ltr");
  document.getElementById("pageTitle").textContent = {
    en: "Spectrum of Awareness",
    de: "Spektrum des Bewusstseins",
    fa: "طیف آگاهی"
  }[currentLang];
  document.getElementById("landingText").textContent = {
  en: "This is a reflection of my inner consciousness, showing me where my awareness lies in the spectrum of being.",
  de: "Dies ist eine Reflexion meines inneren Bewusstseins, die mir zeigt, wo mein Bewusstsein im Spektrum des Seins liegt.",
  fa: "این بازتابی از آگاهی درونی من است که به من نشان می‌دهد آگاهی من در طیف هستی در چه نقطه‌ای قرار دارد."
}[currentLang];
  document.getElementById("startBtn").textContent = {
    en: "Start", de: "Start", fa: "شروع"
  }[currentLang];
  document.getElementById("nextBtn").textContent = {
    en: "Next", de: "Weiter", fa: "بعدی"
  }[currentLang];
  document.getElementById("restartBtn").textContent = {
    en: "Restart", de: "Neu starten", fa: "شروع دوباره"
  }[currentLang];
  document.getElementById("qLblLeft").textContent = {
    en: "Disagree", de: "Stimme nicht zu", fa: "مخالفم"
  }[currentLang];
  document.getElementById("qLblMid").textContent = {
    en: "Uncertain", de: "Unsicher", fa: "مطمئن نیستم"
  }[currentLang];
  document.getElementById("qLblRight").textContent = {
    en: "Agree", de: "Zustimmen", fa: "موافقم"
  }[currentLang];
}
  
// ----------------- SLIDER & QUESTIONS -----------------
let currentQ = 0;
let answers = [];
const questionTextEl = document.getElementById("questionText");
const sliderEl = document.getElementById("questionSlider");
const nextBtnEl = document.getElementById("nextBtn");

// ----------------- MINIMALISTIC DOTS -----------------
function initQuestionDots() {
  const container = document.getElementById("questionDots");
  container.innerHTML = ""; // clear existing dots
  const total = (randomizedQuestions && randomizedQuestions.length>0) ? randomizedQuestions.length : QUESTIONS.length;
  for(let i=0;i<total;i++){
    const dot = document.createElement("span");
    dot.style.display = "inline-block";
    dot.style.width = "10px";
    dot.style.height = "10px";
    dot.style.borderRadius = "50%";
    dot.style.background = "#e6e6e6"; // inactive color (matches slider track)
    dot.style.transition = "background 0.3s, transform 0.2s";
    container.appendChild(dot);
  }
  updateQuestionDots();
}

function updateQuestionDots() {
  const container = document.getElementById("questionDots");
  const total = container.children.length;
  for(let i=0;i<total;i++){
    const dot = container.children[i];
    if(i < currentQ){
      dot.style.background = "var(--accent)";
      dot.style.transform = "scale(1.2)";
    } else {
      dot.style.background = "#e6e6e6";
      dot.style.transform = "scale(1)";
    }
  }
}

// --------- NEW: randomizedQuestions and randomizer function (added only) ---------
// Keeps original QUESTIONS array and text intact and uses randomizedQuestions for display & results.
// Randomization logic: Shuffle within stages then interleave so same-stage doesn't repeat when possible.

let randomizedQuestions = [];

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// Create randomizedQuestions from QUESTIONS while avoiding consecutive same-stage when possible
function randomizeQuestions() {
  // create stage buckets (deep copy items)
  const stageMap = {1: [], 2: [], 3: []};
  QUESTIONS.forEach(q => stageMap[q.stage].push({...q}));

  // shuffle each stage bucket
  Object.keys(stageMap).forEach(k => shuffleArray(stageMap[k]));

  randomizedQuestions = [];
  let lastStage = null;

  while (stageMap[1].length + stageMap[2].length + stageMap[3].length > 0) {
    // choose available stages that are not the last stage if possible
    const available = [1,2,3].filter(s => stageMap[s].length > 0 && s !== lastStage);
    const choice = available.length > 0 ? available[Math.floor(Math.random()*available.length)] : 
                   ( [1,2,3].find(s => stageMap[s].length>0) );
    randomizedQuestions.push(stageMap[choice].shift());
    lastStage = choice;
  }

  // reset pointers and answers
  currentQ = 0;
  answers = [];
}

// ----------------------------------------------------------------------------------

function showQuestion(){
  // use randomizedQuestions (added) if available, else fallback to original QUESTIONS
  const source = (randomizedQuestions && randomizedQuestions.length>0) ? randomizedQuestions : QUESTIONS;
  const q = source[currentQ];
  questionTextEl.textContent = q[currentLang];
  sliderEl.value = 5;
}
nextBtnEl.addEventListener("click", ()=>{
  answers.push(parseFloat(sliderEl.value));
  currentQ++;
  updateQuestionDots();
  // use randomizedQuestions length if available
  const total = (randomizedQuestions && randomizedQuestions.length>0) ? randomizedQuestions.length : QUESTIONS.length;
  if(currentQ >= total){
    showResults();
  } else{
    showQuestion();
  }
});

// ----------------- RESULTS CALCULATION -----------------
function showResults(){
  document.getElementById("questionPane").classList.add("hidden");
  document.getElementById("resultPane").classList.remove("hidden");

  const stageScores = {1:[],2:[],3:[]};

  // Important: map answers to stages using the same order used during question display.
  // If randomizedQuestions exists, iterate that - otherwise fallback to QUESTIONS (unchanged baseline behavior).
  const source = (randomizedQuestions && randomizedQuestions.length>0) ? randomizedQuestions : QUESTIONS;

  source.forEach((q,i)=>{
    // answers[] was collected in the same order we displayed questions, so this mapping matches.
    stageScores[q.stage].push(answers[i]);
  });

  const stageAvg = {
    1: average(stageScores[1]),
    2: average(stageScores[2]),
    3: average(stageScores[3])
  };

  document.getElementById("scoreI").textContent = stageAvg[1].toFixed(1);
  document.getElementById("scoreII").textContent = stageAvg[2].toFixed(1);
  document.getElementById("scoreIII").textContent = stageAvg[3].toFixed(1);

  let maxStage = 1;
  if(stageAvg[2]>=stageAvg[maxStage]) maxStage=2;
  if(stageAvg[3]>=stageAvg[maxStage]) maxStage=3;

  const dominantMessageEl = document.getElementById("dominantMessage");
  dominantMessageEl.classList.remove("hidden");
  dominantMessageEl.innerHTML = STAGE_SUMMARY[maxStage][currentLang];

  const detailsEl = document.getElementById("stageDetails");
  detailsEl.innerHTML = "";

    // ----------------- REPLACE THIS BLOCK WITH CIRCLES -----------------
  STAGE_INFO.forEach((stage,i)=>{
    const score = stageAvg[i+1];
    const stageDiv = document.createElement("div");
    stageDiv.classList.add("stage-desc");

    const descHTML = stage.description[currentLang].map((line,j)=>{
      if(j===0) return line + "\n\n"; // Stage description line

      let circleColor = "#FFCC33"; // default neutral
      let opacity = 0.3; // default low opacity
      let bold = false;

      if(line.startsWith("Close to 10:")){
        if(i===0) circleColor = "#FF6B6B";      // Stage I danger
        if(i===1) circleColor = "#4CAF50";      // Stage II progress
        if(i===2) circleColor = "#4CAF50";      // Stage III peak
        if(score>6) { bold=true; opacity=1; }   // formula preserved
      } else if(line.startsWith("Around 5:")){
        circleColor = "#FFCC33";                 // neutral all stages
        if(score>=4 && score<=6){ bold=true; opacity=1; }
      } else if(line.startsWith("Close to 1:")){
        if(i===0) circleColor = "#4CAF50";      // Stage I better
        if(i===1) circleColor = "#FF6B6B";      // Stage II low
        if(i===2) circleColor = "#FF6B6B";      // Stage III needs integration
        if(score<4) { bold=true; opacity=1; }
      }

      // Circle HTML with tooltip
const circleHTML = `<span style="
    display:inline-block;
    width:14px;
    height:14px;
    border-radius:50%;
    background:${circleColor};
    opacity:${opacity};
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s, opacity 0.3s;
    ${currentLang === 'fa' ? 'margin-left:6px;' : 'margin-right:6px;'}
    vertical-align:middle;"
    title="${line.split(':')[0]}"></span>`;

      const text = line.replace(/^(Close to 10:|Around 5:|Close to 1:)/,'').trim();
      return (bold ? "<strong>"+circleHTML+text+"</strong>" : circleHTML+text);
    }).join("\n\n");

    stageDiv.innerHTML = `<h3 style="font-weight:bold">${stage.title[currentLang]}</h3><p>${descHTML}</p>`;
    detailsEl.appendChild(stageDiv);
  });
}
function calculateOverallAwareness(stageAvg){
  // Determine line colors per stage and per line
  // Line thresholds: Near10>6, Around5 4-6, Near1<4
  const getLineColor = (score, stage, lineIdx) => {
    let color = "#FFCC33"; // default neutral yellow

    if(score>6){ // Near 10
      if(stage===1) color="#FF6B6B"; // Stage I danger
      if(stage===2) color="#4CAF50"; // Stage II progress
      if(stage===3) color="#4CAF50"; // Stage III peak
    } else if(score<4){ // Close to 1
      if(stage===1) color="#4CAF50"; // Stage I better
      if(stage===2) color="#FF6B6B"; // Stage II low
      if(stage===3) color="#FF6B6B"; // Stage III needs integration
    }
    return color;
  };

  // Step 1: simulate 3 lines per stage with same stageAvg (for simplicity)
  const lines = [0,1,2].map(lineIdx=>{
    const colors = [
      getLineColor(stageAvg[1],1,lineIdx),
      getLineColor(stageAvg[2],2,lineIdx),
      getLineColor(stageAvg[3],3,lineIdx)
    ];

    // Combine line colors (🔴+🔴+🟢 etc.)
    // Logic: 3 same -> that color; 2 same -> that color; 1 each -> neutral yellow
    const uniqueColors = [...new Set(colors)];
    if(uniqueColors.length===1) return uniqueColors[0];
    if(uniqueColors.length===2){
      const counts = {};
      colors.forEach(c=>counts[c]=(counts[c]||0)+1);
      return Object.keys(counts).find(k=>counts[k]>1);
    }
    return "#FFCC33"; // neutral
  });

  // Step 2: combine 3 line colors for final overall color
  const uniqueFinal = [...new Set(lines)];
  let finalColor;
  if(uniqueFinal.length===1) finalColor=uniqueFinal[0];
  else if(uniqueFinal.length===2){
    const counts={};
    lines.forEach(c=>counts[c]=(counts[c]||0)+1);
    finalColor=Object.keys(counts).find(k=>counts[k]>1);
  } else finalColor="#FFCC33";

  // Step 3: text messages per language
  const messages = {
    en: {
      "#4CAF50":"I am fully aware of who I am. I move with clarity, grace, and confidence, expanding my consciousness and aligning effortlessly with my true nature.",
      "#FFCC33":"I am partially aware, observing my patterns and growing steadily. I integrate insights into a higher version of myself, unlocking greater awareness and potential.",
      "#FF6B6B":"I am unaware of my true self, caught in the illusion of separation and forgetfulness. My awareness is obscured, and I am still immersed in the patterns of limitation."
    },
    de: {
      "#4CAF50":"Ich bin mir meiner selbst voll bewusst. Ich bewege mich mit Klarheit, Anmut und Vertrauen, erweitere mein Bewusstsein und harmonisiere mühelos mit meiner wahren Natur.",
      "#FFCC33":"Ich bin teilweise bewusst, beobachte meine Muster und wachse stetig. Ich integriere Erkenntnisse in eine höhere Version meiner selbst und erschließe so größeres Bewusstsein und Potenzial.",
      "#FF6B6B":"Ich bin mir meines wahren Selbst nicht bewusst, gefangen in der Illusion der Trennung und des Vergessens. Mein Bewusstsein ist getrübt und ich bin noch in den Mustern der Begrenzung gefangen."
    },
    fa: {
      "#4CAF50":"من کاملاً از خودم آگاه هستم. با وضوح، ظرافت و اعتماد حرکت می‌کنم، آگاهی خود را گسترش می‌دهم و به‌طور طبیعی با ذات واقعی خود هماهنگ می‌شوم.",
      "#FFCC33":"من تا حدی آگاه هستم، الگوهای خود را مشاهده می‌کنم و به طور پیوسته رشد می‌کنم. بینش‌ها را در نسخه‌ای بالاتر از خودم ادغام می‌کنم و آگاهی و پتانسیل بیشتری را فعال می‌کنم.",
      "#FF6B6B":"من از خود واقعی خود آگاه نیستم و در توهم جدایی و فراموشی گرفتار شده‌ام. آگاهی من مبهم است و هنوز در الگوهای محدودیت غرق هستم."
    }
  };

  return {finalColor, finalText:messages[currentLang][finalColor]};
}

// ----------------- Show Overall Result -----------------
function showOverallResult(stageAvg){
  const overallEl = document.getElementById("overallResult");
  const {finalColor, finalText} = calculateOverallAwareness(stageAvg);

  overallEl.innerHTML = `
    <div style="display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:12px;">
      <span style="display:inline-block;width:60px;height:12px;border-radius:6px;background:${finalColor};box-shadow:0 2px 6px rgba(0,0,0,0.1);"></span>
    </div>
    <div style="font-size:15px;line-height:1.5; color:#222;">${finalText}</div>
  `;
  overallEl.classList.remove("hidden");
}

// ----------------- Update showResults() -----------------
function showResults(){
  document.getElementById("questionPane").classList.add("hidden");
  document.getElementById("resultPane").classList.remove("hidden");

  const stageScores = {1:[],2:[],3:[]};
  const source = (randomizedQuestions && randomizedQuestions.length>0) ? randomizedQuestions : QUESTIONS;
  source.forEach((q,i)=>{
    stageScores[q.stage].push(answers[i]);
  });

  const stageAvg = {
    1: average(stageScores[1]),
    2: average(stageScores[2]),
    3: average(stageScores[3])
  };

  document.getElementById("scoreI").textContent = stageAvg[1].toFixed(1);
  document.getElementById("scoreII").textContent = stageAvg[2].toFixed(1);
  document.getElementById("scoreIII").textContent = stageAvg[3].toFixed(1);

  let maxStage = 1;
  if(stageAvg[2]>=stageAvg[maxStage]) maxStage=2;
  if(stageAvg[3]>=stageAvg[maxStage]) maxStage=3;

  const dominantMessageEl = document.getElementById("dominantMessage");
  dominantMessageEl.classList.remove("hidden");
  dominantMessageEl.innerHTML = STAGE_SUMMARY[maxStage][currentLang];

  const detailsEl = document.getElementById("stageDetails");
  detailsEl.innerHTML = "";
  STAGE_INFO.forEach((stage,i)=>{
    const score = stageAvg[i+1];
    const stageDiv = document.createElement("div");
    stageDiv.classList.add("stage-desc");

    const descHTML = stage.description[currentLang].map((line,j)=>{
      if(j===0) return line + "\n\n"; // Stage description line

      let circleColor = "#FFCC33"; // default neutral
      let opacity = 0.3;
      let bold = false;

      if(line.startsWith("Close to 10:")){
        if(i===0) circleColor = "#FF6B6B";
        if(i===1) circleColor = "#4CAF50";
        if(i===2) circleColor = "#4CAF50";
        if(score>6) { bold=true; opacity=1; }
      } else if(line.startsWith("Around 5:")){
        circleColor = "#FFCC33";
        if(score>=4 && score<=6){ bold=true; opacity=1; }
      } else if(line.startsWith("Close to 1:")){
        if(i===0) circleColor = "#4CAF50";
        if(i===1) circleColor = "#FF6B6B";
        if(i===2) circleColor = "#FF6B6B";
        if(score<4) { bold=true; opacity=1; }
      }

      const circleHTML = `<span style="
        display:inline-block;
        width:14px;
        height:14px;
        border-radius:50%;
        background:${circleColor};
        opacity:${opacity};
        box-shadow:0 2px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s, opacity 0.3s;
        ${currentLang === 'fa' ? 'margin-left:6px;' : 'margin-right:6px;'}
        vertical-align:middle;"
        title="${line.split(':')[0]}"></span>`;

      const text = line.replace(/^(Close to 10:|Around 5:|Close to 1:)/,'').trim();
      return (bold ? "<strong>"+circleHTML+text+"</strong>" : circleHTML+text);
    }).join("\n\n");

    stageDiv.innerHTML = `<h3 style="font-weight:bold">${stage.title[currentLang]}</h3><p>${descHTML}</p>`;
    detailsEl.appendChild(stageDiv);
  });

  // Show the new overall result
  showOverallResult(stageAvg);
}
// ----------------- STAGE CLICK TOGGLE -----------------
document.querySelectorAll('.result-stage').forEach((el, idx)=>{
  el.addEventListener('click', ()=>{
    const descs = document.querySelectorAll('.stage-desc');
    descs[idx].style.display = descs[idx].style.display==='none'?'block':'none';
  });
});

function average(arr){
  return arr.reduce((a,b)=>a+b,0)/arr.length;
}

// ----------------- START / RESTART -----------------
document.getElementById("startBtn").addEventListener("click", ()=>{
  document.getElementById("landingPane").classList.add("hidden");
  // NEW: randomize before starting (only added, no other changes)
  randomizeQuestions();
  document.getElementById("questionPane").classList.remove("hidden");
  initQuestionDots();
  showQuestion();
});
document.getElementById("restartBtn").addEventListener("click", ()=>{
  // NEW: randomize on restart as well (only added)
  randomizeQuestions();
  currentQ = 0;
  answers = [];
  document.getElementById("resultPane").classList.add("hidden");
  document.getElementById("questionPane").classList.remove("hidden");
  initQuestionDots(); 
showQuestion();
});

// ----------------- INITIAL LANGUAGE -----------------
applyLanguage();
</script>
</body>
</html>
